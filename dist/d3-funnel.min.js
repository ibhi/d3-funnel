/*! d3-funnel - v0.7.0 | 2015 */
!function(t,i){"function"==typeof define&&define.amd?define(["d3"],i):"object"==typeof exports?module.exports=i(require("d3")):t.D3Funnel=i(t.d3)}(this,function(t){"use strict";function i(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var e=function(){function t(t,i){for(var e=0;e<i.length;e++){var r=i[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(i,e,r){return e&&t(i.prototype,e),r&&t(i,r),i}}(),r=function(){function r(t){i(this,r),this.selector=t,this.colorizer=new h,this.labelFormatter=new o,this.navigator=new s}return e(r,null,[{key:"defaults",value:{chart:{width:350,height:400,bottomWidth:1/3,bottomPinch:0,inverted:!1,animate:!1,curve:{enabled:!1,height:20},showBorder:!1,borderColor:"#000000",borderThickness:4,borderAlpha:100,margin:{top:0,right:0,bottom:0,left:0},bgColor:"none",bgRatio:"100",bgAlpha:"100"},block:{dynamicHeight:!1,fill:{scale:t.scale.category10().domain(t.range(0,10)),type:"solid"},minHeight:!1,highlight:!1},label:{fontSize:"14px",fill:"#fff",format:"{l}: {f}"},events:{click:{block:null}}},enumerable:!0}]),e(r,[{key:"destroy",value:function(){t.select(this.selector).selectAll("svg").remove()}},{key:"draw",value:function(t){var i=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];this.destroy(),this._initialize(t,i),this._draw()}},{key:"_initialize",value:function(t,i){this._validateData(t);var e=this._getSettings(i);this.label=e.label,this.labelFormatter.setFormat(this.label.format),this.colorizer.setLabelFill(e.label.fill),this.colorizer.setScale(e.block.fill.scale),this.bottomWidth=e.chart.width*e.chart.bottomWidth,this.bottomPinch=e.chart.bottomPinch,this.isInverted=e.chart.inverted,this.isCurved=e.chart.curve.enabled,this.curveHeight=e.chart.curve.height,this.fillType=e.block.fill.type,this.hoverEffects=e.block.highlight,this.dynamicHeight=e.block.dynamicHeight,this.minHeight=e.block.minHeight,this.animation=e.chart.animate,this.showBorder=e.chart.showBorder,this.borderColor=e.chart.borderColor,this.borderThickness=e.chart.borderThickness,this.borderAlpha=e.chart.borderAlpha,this.margin=e.chart.margin,this.width=e.chart.width-this.margin.left-this.margin.right,this.height=e.chart.height-this.margin.top-this.margin.bottom,this.bgColor=e.chart.bgColor.split(","),this.bgRatio=e.chart.bgRatio.split(","),this.bgAlpha=e.chart.bgAlpha.split(","),this.onBlockClick=e.events.click.block,this._setBlocks(t),this.bottomLeftX=(this.width-this.bottomWidth)/2,this.dx=this._getDx(),this.dy=this._getDy()}},{key:"_validateData",value:function(t){if(Array.isArray(t)===!1||0===t.length||Array.isArray(t[0])===!1||t[0].length<2)throw new Error("Funnel data is not valid.")}},{key:"_getSettings",value:function(i){var e=a.extend({},r.defaults);return e.chart.width=parseInt(t.select(this.selector).style("width"),10),e.chart.height=parseInt(t.select(this.selector).style("height"),10),e=a.extend(e,i),e.chart.width<=0&&(e.chart.width=r.defaults.chart.width),e.chart.height<=0&&(e.chart.height=r.defaults.chart.height),e}},{key:"_setBlocks",value:function(t){var i=this._getTotalCount(t);this.blocks=this._standardizeData(t,i)}},{key:"_getTotalCount",value:function(t){var i=this,e=0;return t.forEach(function(t){e+=i._getRawBlockCount(t)}),e}},{key:"_standardizeData",value:function(t,i){var e=this,r=[],h=void 0,o=void 0,s=void 0;return t.forEach(function(t,a){h=e._getRawBlockCount(t),o=h/i,s=t[0],r.push({index:a,value:h,ratio:o,height:e.height*o,formatted:e.labelFormatter.format(s,h),fill:e.colorizer.getBlockFill(t,a),label:{raw:s,formatted:e.labelFormatter.format(s,h),color:e.colorizer.getLabelFill(t,a)}})}),r}},{key:"_getRawBlockCount",value:function(t){return Array.isArray(t[1])?t[1][0]:t[1]}},{key:"_getDx",value:function(){return this.bottomPinch>0?this.bottomLeftX/(this.blocks.length-this.bottomPinch):this.bottomLeftX/this.blocks.length}},{key:"_getDy",value:function(){return this.isCurved?(this.height-this.curveHeight)/this.blocks.length:this.height/this.blocks.length}},{key:"_draw",value:function(){this.svg=t.select(this.selector).append("svg").attr("width",this.width+this.margin.left+this.margin.right).attr("height",this.height+this.margin.top+this.margin.bottom),this.showBorder&&this._showBorder(this.svg),this.bgColor[0]&&this._showBackground(this.svg),this.svg=this.svg.append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")"),this.blockPaths=this._makePaths(),"gradient"===this.fillType&&this._defineColorGradients(this.svg),this.isCurved&&this._drawTopOval(this.svg,this.blockPaths),this._drawBlock(0)}},{key:"_makePaths",value:function(){var t=this,i=[],e=this.dx,r=this.dy,h=0,o=this.width,s=0;this.isInverted&&(h=this.bottomLeftX,o=this.width-this.bottomLeftX);var a=0,n=0,l=0,c=this.width/2;this.isCurved&&(s=10);var u=this.height;this.minHeight!==!1&&(u=this.height-this.minHeight*this.blocks.length);var d=this.height;this.blocks.forEach(function(i,e){t.bottomPinch>0&&(t.isInverted?e<t.bottomPinch&&(d-=i.height):e>=t.blocks.length-t.bottomPinch&&(d-=i.height))});var g=2*d/(this.width-this.bottomWidth);return this.blocks.forEach(function(d,f){t.dynamicHeight&&(r=u*d.ratio,t.minHeight!==!1&&(r+=t.minHeight),t.isCurved&&(r-=t.curveHeight/t.blocks.length),a=(s+r)/g,t.isInverted&&(a=(s+r-t.height)/(-1*g)),0===t.bottomWidth&&f===t.blocks.length-1&&(a=t.width/2,t.isInverted&&(a=0)),t.bottomWidth===t.width&&(a=h),e=a-h,t.isInverted&&(e=h-a)),t.bottomPinch>0&&(t.isInverted?(t.dynamicHeight||(e=t.dx),e=f<t.bottomPinch?0:e):f>=t.blocks.length-t.bottomPinch&&(e=0)),a=h+e,n=o-e,l=s+r,t.isInverted&&(a=h-e,n=o+e),t.isCurved?i.push([[h,s,"M"],[c,s+(t.curveHeight-10),"Q"],[o,s,""],[n,l,"L"],[n,l,"M"],[c,l+t.curveHeight,"Q"],[a,l,""],[h,s,"L"]]):i.push([[h,s,"M"],[o,s,"L"],[n,l,"L"],[a,l,"L"],[h,s,"L"]]),h=a,o=n,s=l}),i}},{key:"_defineColorGradients",value:function(t){var i=t.append("defs");this.blocks.forEach(function(t,e){var r=t.fill,o=h.shade(r,-.25),s=i.append("linearGradient").attr({id:"gradient-"+e}),a=[[0,o],[40,r],[60,r],[100,o]];a.forEach(function(t){s.append("stop").attr({offset:t[0]+"%",style:"stop-color:"+t[1]})})})}},{key:"_drawTopOval",value:function(t,i){var e=0,r=this.width,o=this.width/2;this.isInverted&&(e=this.bottomLeftX,r=this.width-this.bottomLeftX);var s=i[0],a=s[1][1]+this.curveHeight-10,n=this.navigator.plot([["M",e,s[0][1]],["Q",o,a],[" ",r,s[2][1]],["M",r,10],["Q",o,0],[" ",e,10]]);t.append("path").attr("fill",h.shade(this.blocks[0].fill,-.4)).attr("d",n)}},{key:"_drawBlock",value:function(t){var i=this;if(t!==this.blocks.length){var e=this.svg.append("g"),r=this._getBlockPath(e,t);r.data(this._getD3Data(t)),this.animation!==!1?r.transition().duration(this.animation).ease("linear").attr("fill",this._getFillColor(t)).attr("d",this._getPathDefinition(t)).each("end",function(){i._drawBlock(t+1)}):(r.attr("fill",this._getFillColor(t)).attr("d",this._getPathDefinition(t)),this._drawBlock(t+1)),this.hoverEffects&&r.on("mouseover",this._onMouseOver).on("mouseout",this._onMouseOut),null!==this.onBlockClick&&r.on("click",this.onBlockClick),this._addBlockLabel(e,t)}}},{key:"_getBlockPath",value:function(t,i){var e=t.append("path");return this.animation!==!1&&this._addBeforeTransition(e,i),e}},{key:"_addBeforeTransition",value:function(t,i){var e=this.blockPaths[i],r="",h="";r=this.isCurved?this.navigator.plot([["M",e[0][0],e[0][1]],["Q",e[1][0],e[1][1]],[" ",e[2][0],e[2][1]],["L",e[2][0],e[2][1]],["M",e[2][0],e[2][1]],["Q",e[1][0],e[1][1]],[" ",e[0][0],e[0][1]]]):this.navigator.plot([["M",e[0][0],e[0][1]],["L",e[1][0],e[1][1]],["L",e[1][0],e[1][1]],["L",e[0][0],e[0][1]]]),h="solid"===this.fillType&&i>0?this._getFillColor(i-1):this._getFillColor(i),t.attr("d",r).attr("fill",h)}},{key:"_getD3Data",value:function(t){return[this.blocks[t]]}},{key:"_getFillColor",value:function(t){return"solid"===this.fillType?this.blocks[t].fill:"url(#gradient-"+t+")"}},{key:"_getPathDefinition",value:function(t){var i=[];return this.blockPaths[t].forEach(function(t){i.push([t[2],t[0],t[1]])}),this.navigator.plot(i)}},{key:"_onMouseOver",value:function(i){t.select(this).attr("fill",h.shade(i.fill,-.2))}},{key:"_onMouseOut",value:function(i){t.select(this).attr("fill",i.fill)}},{key:"_addBlockLabel",value:function(t,i){var e=this.blockPaths[i],r=this.blocks[i].label.formatted,h=this.blocks[i].label.color,o=this.width/2,s=this._getTextY(e);t.append("text").text(r).attr({x:o,y:s,"text-anchor":"middle","dominant-baseline":"middle",fill:h,"pointer-events":"none"}).style("font-size",this.label.fontSize)}},{key:"_getTextY",value:function(t){return this.isCurved?(t[2][1]+t[3][1])/2+this.curveHeight/this.blocks.length:(t[1][1]+t[2][1])/2}},{key:"_showBorder",value:function(t){t.attr("border",1).append("rect").attr("x",0).attr("y",0).attr("height",this.height+this.margin.top+this.margin.bottom).attr("width",this.width+this.margin.left+this.margin.right).style("fill","none").style("stroke",this.borderColor).style("stroke-width",this.borderThickness).style("stroke-opacity",this.borderAlpha/100)}},{key:"_showBackground",value:function(t){return 1===this.bgColor.length?void t.append("rect").attr("x",this.borderThickness/2).attr("y",this.borderThickness/2).attr("height",this.height+this.margin.top+this.margin.bottom-this.borderThickness).attr("width",this.width+this.margin.left+this.margin.right-this.borderThickness).style("fill",this.bgColor[0]):(this.colorizer.linearGradientGenerator(t,this.bgColor,this.bgAlpha,this.bgRatio),void t.append("rect").attr("x",this.borderThickness/2).attr("y",this.borderThickness/2).attr("height",this.height+this.margin.top+this.margin.bottom-this.borderThickness).attr("width",this.width+this.margin.left+this.margin.right-this.borderThickness).style("fill","url(#gradient)"))}}]),r}(),h=function(){function t(){i(this,t),this.hexExpression=/^#([0-9a-f]{3}|[0-9a-f]{6})$/i,this.labelFill=null,this.scale=null}return e(t,[{key:"setLabelFill",value:function(t){this.labelFill=t}},{key:"setScale",value:function(t){this.scale=t}},{key:"getBlockFill",value:function(t,i){return t.length>2&&this.hexExpression.test(t[2])?t[2]:Array.isArray(this.scale)?this.scale[i]:this.scale(i)}},{key:"getLabelFill",value:function(t){return t.length>3&&this.hexExpression.test(t[3])?t[3]:this.labelFill}},{key:"_validateColors",value:function(t){var i=this;if(Array.isArray(t)===!1||0===t.length)throw new Error("Atleast specify one color.");t.forEach(function(t){if(!i.hexExpression.test(t))throw new Error("Invalid color format.")})}},{key:"linearGradientGenerator",value:function(t,i,e,r){this._validateColors(i);var h=t.append("defs").append("linearGradient").attr("id","gradient").attr("x1","0%").attr("x2","0%").attr("y1","0%").attr("y2","100%");i.forEach(function(t,i){h.append("stop").attr("offset",r[i]+"%").attr("stop-color",t).attr("stop-opacity",e[i]/100)})}}],[{key:"shade",value:function(i,e){var r=i.slice(1);3===r.length&&(r=t.expandHex(r));var h=parseInt(r,16),o=0>e?0:255,s=0>e?-1*e:e,a=h>>16,n=h>>8&255,l=255&h,c=16777216+65536*(Math.round((o-a)*s)+a)+256*(Math.round((o-n)*s)+n)+(Math.round((o-l)*s)+l);return"#"+c.toString(16).slice(1)}},{key:"expandHex",value:function(t){return t[0]+t[0]+t[1]+t[1]+t[2]+t[2]}}]),t}(),o=function(){function t(){i(this,t),this.expression=null}return e(t,[{key:"setFormat",value:function(t){"function"==typeof t?this.formatter=t:(this.expression=t,this.formatter=this.stringFormatter)}},{key:"format",value:function(t,i){return Array.isArray(i)?this.formatter(t,i[0],i[1]):this.formatter(t,i,null)}},{key:"stringFormatter",value:function(t,i){var e=arguments.length<=2||void 0===arguments[2]?null:arguments[2],r=e;return null===e&&(r=this.getDefaultFormattedValue(i)),this.expression.split("{l}").join(t).split("{v}").join(i).split("{f}").join(r)}},{key:"getDefaultFormattedValue",value:function(t){return t.toLocaleString()}}]),t}(),s=function(){function t(){i(this,t)}return e(t,[{key:"plot",value:function(t){var i="";return t.forEach(function(t){i+=t[0]+t[1]+","+t[2]+" "}),i.replace(/ +/g," ").trim()}}]),t}(),a=function(){function t(){i(this,t)}return e(t,null,[{key:"extend",value:function(i,e){var r=void 0;for(r in e)e.hasOwnProperty(r)&&("object"!=typeof e[r]||Array.isArray(e[r])?i[r]=e[r]:"object"!=typeof i[r]||Array.isArray(i[r])?i[r]=t.extend({},e[r]):i[r]=t.extend(i[r],e[r]));return i}}]),t}();return r});